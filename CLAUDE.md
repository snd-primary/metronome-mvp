# ポリリズミック・メトロノーム PoC 開発サマリー

## 実装した機能

### 1. データ構造設計

複数の拍を管理するデータ構造を実装しました。

```typescript
type Beat = {
  id: string;
  divisions: number;  // この拍の分割数（リズムパターン）
  color: string;
};
各拍が独立した分割数（リズムパターン）を持つ
4拍子であれば4つのBeatオブジェクトが存在
各拍は異なる分割数を設定可能（例: 4分割、3分割、8分割など）
2. メトロノーム統合
useMetronomeフックと統合し、音符（segment）単位でのクリック音を実装しました。 動作:
各拍の各セグメントごとにクリック音が鳴る
例: 4拍子で各拍が4分割の場合、1周期で16回クリック音が鳴る
3. ビジュアライゼーション
SVGを使用した円形ビジュアライザーを実装しました。 特徴:
各拍が独立した円として表示
拍の分割数に応じてセグメントに分割
クリック音に同期してセグメントが塗りつぶされる
全セグメントが鳴り終わったら自動的にリセット
視覚的な動作:
初期状態: 全てのセグメントは枠線のみ
クリック音が鳴る: 対応するセグメントが塗りつぶされる
過去の拍: 全セグメントが塗りつぶされた状態を維持
周期完了: 全ての塗りつぶしがクリアされ、最初に戻る
4. 再生位置管理（useReducer）
useReducerを使用して、クリック音とビジュアルの同期を実現しました。

type PlaybackPosition = {
  beatIndex: number;      // 現在の拍のインデックス
  segmentIndex: number;   // 現在のセグメントのインデックス
};
重要な修正:
拍の切り替え時: segmentIndex: 0（即座に次の拍の最初のセグメントを鳴らす）
周期完了時: { beatIndex: 0, segmentIndex: 0 }（最初の拍の最初のセグメントから開始）
これにより、クリック音と視覚的な塗りつぶしのズレを解消
5. UIコントロール
メトロノームコントロール
再生/停止ボタン
BPM調整（40〜300、±10刻み）
拍子設定
プリセットボタン（2〜8拍子）
拍の手動追加/削除
各拍の分割数調整
各拍ごとに独立して分割数を調整可能
最小1分割から無制限
技術的なポイント
クリック音と視覚の同期
課題:
isBeatが発火した後に状態更新が行われるため、拍の切り替わり時にズレが発生
解決策:
拍の切り替え時にsegmentIndex: 0を即座に設定
これにより、クリック音が鳴ったタイミングで対応するセグメントが塗りつぶされる
React Hooks最適化
useEffect内でのcascading renders警告の解消:
複数のsetStateをネストして呼び出していた問題を、useReducerを使用して単一のdispatchに集約
パフォーマンスの向上とReactのベストプラクティスに準拠
SVGパス生成
円形分割の数学的処理:
極座標からデカルト座標への変換
内側半径と外側半径を使用したドーナツ状の扇形パス生成
角丸処理と枠線の2層レンダリング
今後の拡張ポイント
レイアウトの最適化（円の配置を横並び、円形配置など）
各拍ごとの音色設定
プリセットパターンの保存/読み込み
より複雑なリズムパターンのサポート
実装期間: 2025-12-22
主要ファイル: src/App.tsx, src/hooks/useMetronome.ts
```
