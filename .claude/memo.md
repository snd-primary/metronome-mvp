ポリリズミック・メトロノーム PoC 開発サマリー
実装した機能

1. データ構造設計
   複数の拍を管理するデータ構造を実装しました。

type Beat = {
id: string;
divisions: number; // この拍の分割数（リズムパターン）
color: string;
};
各拍が独立した分割数（リズムパターン）を持つ
4 拍子であれば 4 つの Beat オブジェクトが存在
各拍は異なる分割数を設定可能（例: 4 分割、3 分割、8 分割など） 2. メトロノーム統合
useMetronome フックと統合し、音符（segment）単位でのクリック音を実装しました。 動作:
各拍の各セグメントごとにクリック音が鳴る
例: 4 拍子で各拍が 4 分割の場合、1 周期で 16 回クリック音が鳴る 3. ビジュアライゼーション
SVG を使用した円形ビジュアライザーを実装しました。 特徴:
各拍が独立した円として表示
拍の分割数に応じてセグメントに分割
クリック音に同期してセグメントが塗りつぶされる
全セグメントが鳴り終わったら自動的にリセット
視覚的な動作:
初期状態: 全てのセグメントは枠線のみ
クリック音が鳴る: 対応するセグメントが塗りつぶされる
過去の拍: 全セグメントが塗りつぶされた状態を維持
周期完了: 全ての塗りつぶしがクリアされ、最初に戻る 4. 再生位置管理（useReducer）
useReducer を使用して、クリック音とビジュアルの同期を実現しました。

type PlaybackPosition = {
beatIndex: number; // 現在の拍のインデックス
segmentIndex: number; // 現在のセグメントのインデックス
};
重要な修正:
拍の切り替え時: segmentIndex: 0（即座に次の拍の最初のセグメントを鳴らす）
周期完了時: { beatIndex: 0, segmentIndex: 0 }（最初の拍の最初のセグメントから開始）
これにより、クリック音と視覚的な塗りつぶしのズレを解消 5. UI コントロール
メトロノームコントロール
再生/停止ボタン
BPM 調整（40〜300、±10 刻み）
拍子設定
プリセットボタン（2〜8 拍子）
拍の手動追加/削除
各拍の分割数調整
各拍ごとに独立して分割数を調整可能
最小 1 分割から無制限
技術的なポイント
クリック音と視覚の同期
課題:
isBeat が発火した後に状態更新が行われるため、拍の切り替わり時にズレが発生
解決策:
拍の切り替え時に segmentIndex: 0 を即座に設定
これにより、クリック音が鳴ったタイミングで対応するセグメントが塗りつぶされる
React Hooks 最適化
useEffect 内での cascading renders 警告の解消:
複数の setState をネストして呼び出していた問題を、useReducer を使用して単一の dispatch に集約
パフォーマンスの向上と React のベストプラクティスに準拠
SVG パス生成
円形分割の数学的処理:
極座標からデカルト座標への変換
内側半径と外側半径を使用したドーナツ状の扇形パス生成
角丸処理と枠線の 2 層レンダリング
今後の拡張ポイント
レイアウトの最適化（円の配置を横並び、円形配置など）
各拍ごとの音色設定
プリセットパターンの保存/読み込み
より複雑なリズムパターンのサポート
実装期間: 2025-12-22
ファイル: src/App.tsx, src/hooks/useMetronome.ts
